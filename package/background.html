<html>
<meta charset="utf-8">
<head><title>Background</title></head>
<script type="text/javascript" src="./ibm_model1.js">
</script>
<script type="text/javascript">
var config = {};
var model = new IBM_Model_1();
function load() {
  var auto_select = localStorage["auto_select"];
  if (!auto_select) {
    auto_select = "on";
  }

  var suggest = localStorage["suggest"];
  if (!suggest) {
    suggest = "strict";
  }

  var position = localStorage["position"];
  if (!position) {
    position = "under";
  }

  var learning = localStorage["learning"];
  if (!learning) {
    learning = "enable";
  }

  var json = localStorage["model"];
  if (json) {
    json = JSON.parse(json);
    model.prob = json.prob;
    model.pair = json.pair;
  }

  config = {
    auto_select: auto_select,
    suggest: suggest,
    position: position,
    learning: learning
  };
}

var count = 0;
chrome.extension.onRequest.addListener(
  function(request, sender, sendResponse) {
    if(request.type == "get") {
      sendResponse(config);
    } else if(request.type == "set") {
      load();
      sendResponse(config);
    } else if(request.type == "train") {
      sendResponse(null);
      if(config.learning == 'enable') {
        model.countOne([request.target, request.source]);
        count++;
        if(count >= 2) {
          model.train();
          count -= 2;
        }
        localStorage["model"] = JSON.stringify(model)
      }
    } else if(request.type == "suggest") {
      if(config.learning == 'enable') {
        sendResponse(model.suggest(request.source).slice(0, 5));
      }
    } else if(request.type == "reset") {
      model = new IBM_Model_1();
      delete localStorage['model'];
    }
  }
);
</script>
<body onload="load();">
</body>
</html>